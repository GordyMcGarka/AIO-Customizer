name: Update Switch Versions

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get latest versions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          get_latest() {
            repo="$1"

            release=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$repo/releases/latest")

            tag=$(echo "$release" | jq -r '.tag_name // empty')

            if [ -z "$tag" ]; then
              tag=$(curl -s \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$repo/tags" \
                | jq -r '.[0].name // empty')
            fi

            echo "$tag"
          }

          atmosphere_new=$(get_latest "Atmosphere-NX/Atmosphere")
          hekate_new=$(get_latest "CTCaer/hekate")
          sys_patch_new=$(get_latest "impeeza/sys-patch")
          firmware_new=$(get_latest "THZoria/NX_Firmware")

          atmosphere_old=$(grep "^atmosphere=" RELEASE.ini 2>/dev/null | cut -d= -f2 || true)
          hekate_old=$(grep "^hekate=" RELEASE.ini 2>/dev/null | cut -d= -f2 || true)
          sys_patch_old=$(grep "^sys-patch=" RELEASE.ini 2>/dev/null | cut -d= -f2 || true)
          firmware_old=$(grep "^firmware=" RELEASE.ini 2>/dev/null | cut -d= -f2 || true)

          atmosphere=${atmosphere_new:-$atmosphere_old}
          hekate=${hekate_new:-$hekate_old}
          sys_patch=${sys_patch_new:-$sys_patch_old}
          firmware=${firmware_new:-$firmware_old}

          {
            echo "[Release Info]"
            echo "atmosphere=$atmosphere"
            echo "hekate=$hekate"
            echo "sys-patch=$sys_patch"
            echo "firmware=$firmware"
          } > RELEASE.ini

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add RELEASE.ini

          if ! git diff-index --quiet HEAD; then
            git commit -m "Update Switch versions"
            git pull --rebase origin main || true
            git push origin main
          else
            echo "No changes to commit."
          fi
